<system>
  @log_level debug
</system>

#
# Fluentd 設定例（Lokiを使わず、Lambdaへ「パーティ参加」ログだけ送る）
#
# - Windows など環境ごとに `path/pos_file/buffer.path` は実パスに置き換えてください
#

<source>
  @type tail
  path "{input_act_path}/*.log"
  pos_file "{input_path}/ffxiv.pos"
  tag ffxiv.logs
  encoding utf-8
  from_encoding utf-8
  read_from_head true
  <parse>
    @type regexp
    expression /^(?<prefix>\d+)\|(?<timestamp>[^|]+)\|(?<rest>.*)$/
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%N%:z
    keep_time_key true
  </parse>
</source>

<filter ffxiv.logs>
  @type record_transformer
  enable_ruby true
  <record>
    line ${record["prefix"]}|${record["timestamp"]}|${record["rest"]}
  </record>
</filter>

<match ffxiv.logs>
  @type relabel
  @label @lambda
</match>

<label @lambda>
  <filter ffxiv.logs>
    @type grep
    <regexp>
      key line
      pattern がパーティに参加しました
    </regexp>
  </filter>

  # NOTE:
  # - 送信先URLは SAM デプロイ後の Outputs.ApiEndpoint を利用してください
  <match ffxiv.logs>
    @type http
    url "{URL}"
    http_method post
    serializer json

    <format>
      @type json
    </format>

    <buffer>
      @type file
      path "{input_path}/buffer_lambda"
      flush_interval 5s
      retry_max_interval 1m
      chunk_limit_size 1m
    </buffer>
  </match>
</label>
